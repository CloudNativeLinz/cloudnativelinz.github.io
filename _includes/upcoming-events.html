
{% assign upcoming_events = false %}
{% assign today = site.time | date: "%Y-%m-%d" %}
{% for event in site.data.events %}
  {% assign event_date = event.date | date: "%Y-%m-%d" %}
  {% if event_date >= today %}
    {% assign upcoming_events = true %}
    {% break %}
  {% endif %}
{% endfor %}

{% if upcoming_events %}
## Upcoming events

<div class="events-carousel-container">
  <div class="events-carousel">
    <div class="events-carousel-track">
{% for event in site.data.events %}
 {% assign event_date = event.date | date: "%Y-%m-%d" %}
 {% assign today = site.time | date: "%Y-%m-%d" %}
  
 {% if event_date >= today %}
  <article class="event-card" data-event-id="{{ event.id }}">
    <div class="event-banner">
      <img src="https://raw.githubusercontent.com/CloudNativeLinz/go-image-generator/main/artifacts/{{ event.id }}.jpg" 
           alt="{{ event.title }}" 
           loading="lazy"
           onerror="this.src='https://raw.githubusercontent.com/CloudNativeLinz/go-image-generator/refs/heads/main/assets/backgrounds/meetup-background.jpg'"
      />
      <div class="event-overlay">
        <div class="event-date">
          {% if event_date == today %}
            <span class="today-badge">TODAY</span>
          {% else %}
            {{ event.date | date: "%b %d, %Y" }}
          {% endif %}
        </div>
        {% if event.host != nil and event.host != "" %}
          <div class="event-host">üìç {{ event.host }}</div>
        {% endif %}
      </div>
    </div>
    
    <div class="event-content">
      <h3 class="event-title">
        <a href="{{ site.url }}{{ site.baseurl }}/events/{{ event.title | datapage_url: 'meetup' | remove: '.html' }}">{{ event.title }}</a>
      </h3>
      
      {% if event.talks %}
        <div class="event-talks">
          {% for talk in event.talks limit:2 %}
            <div class="talk-item">
              <div class="talk-title">{{ talk.title }}</div>
              <div class="talk-speaker">
                <span class="emoji" style="font-style: normal;">üë®‚Äçüíª</span>
                <span class="talk-speaker-name">{{ talk.speaker }}</span><br>
                {% if talk.file %}
                  <a href="{{ site.url }}{{ site.baseurl }}/events/{{ event.title | datapage_url: 'meetup' | remove: '.html' }}">
                    üìé Get the slides 
                  </a>
                {% endif %}
                 {% if talk.recording %}
                  <a href="{{ site.url }}{{ site.baseurl }}/events/{{ event.title | datapage_url: 'meetup' | remove: '.html' }}">
                    üì∫ Watch the recording
                  </a>
                {% endif %}
              </div>
            </div>
          {% endfor %}
          {% if event.talks.size > 2 %}
            <div class="talk-item more-talks">
              <div class="talk-title">+{{ event.talks.size | minus: 2 }} more talk{% if event.talks.size > 3 %}s{% endif %}</div>
            </div>
          {% endif %}
        </div>
      {% endif %}
      
      <div class="event-meta">
        {% if event.participants != "" %}
          <span class="meta-item">
            <svg class="icon" viewBox="0 0 20 20" fill="currentColor">
              <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
            </svg>
            {{ event.participants }} cloud-natives participated
          </span>
        {% else %}
          <span class="meta-item">
            <svg class="icon" viewBox="0 0 20 20" fill="currentColor">
              <path d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            Please don't forget to RSVP :)
          </span>
        {% endif %}
        
        <a class="meta-link" href="{{ site.url }}{{ site.baseurl }}/events/{{ event.title | datapage_url: 'meetup' | remove: '.html' }}">Event details</a>

        {% if event.event_link and event.event_link != "" %}
          <a href="{{ event.event_link }}" class="meta-link" target="_blank" rel="noopener">
            <svg class="icon" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/>
            </svg>
            RSVP and join this awesome event!
          </a>
        {% else %}
          <span class="meta-item">
            <svg class="icon" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            Registration opening soon
          </span>
        {% endif %}
      </div>
    </div>
  </article>
 {% endif %}
{% endfor %}
    </div>
  </div>
  
  <!-- Carousel Navigation -->
  <button class="carousel-btn carousel-btn-prev" onclick="moveCarousel(-1)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polyline points="15,18 9,12 15,6"></polyline>
    </svg>
  </button>
  <button class="carousel-btn carousel-btn-next" onclick="moveCarousel(1)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polyline points="9,6 15,12 9,18"></polyline>
    </svg>
  </button>
  
  <!-- Carousel Indicators -->
  <div class="carousel-indicators">
    <!-- Will be populated by JavaScript -->
  </div>
</div>

<script>
// Carousel functionality for upcoming events
let currentSlide = 0;
let eventsCarousel = null;
let eventsTrack = null;
let totalSlides = 0;
let isInitialized = false;
let autoAdvanceInterval = null;

function initializeCarousel() {
  if (isInitialized) return;
  
  eventsCarousel = document.querySelector('.events-carousel');
  eventsTrack = document.querySelector('.events-carousel-track');
  
  if (!eventsCarousel || !eventsTrack) return;
  
  const eventCards = eventsTrack.querySelectorAll('.event-card');
  totalSlides = eventCards.length;
  
  if (totalSlides === 0) return;
  
  const carouselContainer = document.querySelector('.events-carousel-container');
  
  // Mark container for single slide styling
  if (totalSlides === 1) {
    carouselContainer.setAttribute('data-single-slide', 'true');
  } else {
    carouselContainer.setAttribute('data-single-slide', 'false');
  }
  
  // Create indicators only if more than one slide
  if (totalSlides > 1) {
    createIndicators();
    setupNavigationButtons();
  }
  
  // Set initial ARIA attributes
  updateAriaAttributes();
  
  updateCarouselPosition();
  isInitialized = true;
  
  console.log(`Carousel initialized with ${totalSlides} slides`);
}

function createIndicators() {
  const indicatorsContainer = document.querySelector('.carousel-indicators');
  indicatorsContainer.innerHTML = '';
  
  for (let i = 0; i < totalSlides; i++) {
    const indicator = document.createElement('button');
    indicator.className = `carousel-indicator ${i === 0 ? 'active' : ''}`;
    indicator.setAttribute('aria-label', `Go to slide ${i + 1}`);
    indicator.onclick = () => goToSlide(i);
    indicatorsContainer.appendChild(indicator);
  }
}

function setupNavigationButtons() {
  const prevBtn = document.querySelector('.carousel-btn-prev');
  const nextBtn = document.querySelector('.carousel-btn-next');
  
  if (prevBtn && nextBtn) {
    prevBtn.setAttribute('aria-label', 'Previous event');
    nextBtn.setAttribute('aria-label', 'Next event');
    
    // Add keyboard support
    prevBtn.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        moveCarousel(-1);
      }
    });
    
    nextBtn.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        moveCarousel(1);
      }
    });
  }
}

function moveCarousel(direction) {
  if (totalSlides <= 1) return;
  
  stopAutoAdvance(); // Stop auto-advance when user interacts
  
  currentSlide += direction;
  
  if (currentSlide >= totalSlides) {
    currentSlide = 0;
  } else if (currentSlide < 0) {
    currentSlide = totalSlides - 1;
  }
  
  updateCarouselPosition();
  
  // Restart auto-advance after user interaction
  setTimeout(() => {
    if (document.querySelector('.events-carousel-container:hover') === null) {
      startAutoAdvance();
    }
  }, 3000);
}

function goToSlide(slideIndex) {
  if (slideIndex >= 0 && slideIndex < totalSlides && slideIndex !== currentSlide) {
    stopAutoAdvance();
    currentSlide = slideIndex;
    updateCarouselPosition();
    
    // Restart auto-advance
    setTimeout(() => {
      if (document.querySelector('.events-carousel-container:hover') === null) {
        startAutoAdvance();
      }
    }, 3000);
  }
}

function updateCarouselPosition() {
  if (!eventsTrack) return;
  
  const translateX = -currentSlide * 100;
  eventsTrack.style.transform = `translateX(${translateX}%)`;
  
  // Update indicators
  const indicators = document.querySelectorAll('.carousel-indicator');
  indicators.forEach((indicator, index) => {
    indicator.classList.toggle('active', index === currentSlide);
    indicator.setAttribute('aria-pressed', index === currentSlide ? 'true' : 'false');
  });
  
  // Update button states (don't disable for infinite loop)
  const prevBtn = document.querySelector('.carousel-btn-prev');
  const nextBtn = document.querySelector('.carousel-btn-next');
  
  if (prevBtn && nextBtn) {
    // For infinite carousel, buttons are never disabled
    prevBtn.disabled = false;
    nextBtn.disabled = false;
  }
  
  updateAriaAttributes();
}

function updateAriaAttributes() {
  const eventCards = eventsTrack.querySelectorAll('.event-card');
  eventCards.forEach((card, index) => {
    const isVisible = index === currentSlide;
    card.setAttribute('aria-hidden', !isVisible);
    card.setAttribute('tabindex', isVisible ? '0' : '-1');
  });
  
  // Update carousel region
  const carouselContainer = document.querySelector('.events-carousel-container');
  if (carouselContainer) {
    carouselContainer.setAttribute('aria-label', `Event ${currentSlide + 1} of ${totalSlides}`);
  }
}

function startAutoAdvance() {
  if (totalSlides <= 1 || autoAdvanceInterval) return;
  
  // Check if user prefers reduced motion
  if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
    return;
  }
  
  autoAdvanceInterval = setInterval(() => {
    moveCarousel(1);
  }, 8000); // Change slide every 8 seconds
}

function stopAutoAdvance() {
  if (autoAdvanceInterval) {
    clearInterval(autoAdvanceInterval);
    autoAdvanceInterval = null;
  }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(initializeCarousel, 100);
});

// Also initialize after a short delay in case DOM isn't fully ready
setTimeout(() => {
  if (!isInitialized) {
    initializeCarousel();
  }
}, 500);

// Add intersection observer for scroll animations and auto-advance trigger
if ('IntersectionObserver' in window) {
  const carouselContainer = document.querySelector('.events-carousel-container');
  
  if (carouselContainer) {
    const carouselObserver = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          // Start auto-advance when carousel becomes visible
          setTimeout(() => {
            if (isInitialized) {
              startAutoAdvance();
            }
          }, 2000);
        } else {
          // Stop auto-advance when carousel is not visible
          stopAutoAdvance();
        }
      });
    }, {
      threshold: 0.3,
      rootMargin: '50px'
    });
    
    carouselObserver.observe(carouselContainer);
  }
  
  // Animate individual cards
  const upcomingCards = document.querySelectorAll('.events-carousel .event-card');
  const upcomingObserver = new IntersectionObserver((entries) => {
    entries.forEach((entry, index) => {
      if (entry.isIntersecting) {
        setTimeout(() => {
          entry.target.style.opacity = '1';
          entry.target.style.transform = 'translateY(0)';
        }, index * 100);
        upcomingObserver.unobserve(entry.target);
      }
    });
  }, {
    threshold: 0.1,
    rootMargin: '50px'
  });
  
  upcomingCards.forEach((card) => {
    if (!card.style.opacity) {
      card.style.opacity = '0';
      card.style.transform = 'translateY(30px)';
      card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
      upcomingObserver.observe(card);
    }
  });
}

// Pause auto-advance on hover and focus
document.addEventListener('DOMContentLoaded', () => {
  const carouselContainer = document.querySelector('.events-carousel-container');
  if (carouselContainer) {
    carouselContainer.addEventListener('mouseenter', stopAutoAdvance);
    carouselContainer.addEventListener('mouseleave', () => {
      setTimeout(startAutoAdvance, 1000);
    });
    
    carouselContainer.addEventListener('focusin', stopAutoAdvance);
    carouselContainer.addEventListener('focusout', () => {
      setTimeout(startAutoAdvance, 1000);
    });
  }
});

// Handle touch events for mobile swipe
let touchStartX = 0;
let touchEndX = 0;
let touchStartY = 0;
let touchEndY = 0;
let isSwiping = false;

document.addEventListener('DOMContentLoaded', () => {
  const carouselContainer = document.querySelector('.events-carousel-container');
  if (carouselContainer) {
    carouselContainer.addEventListener('touchstart', (e) => {
      touchStartX = e.changedTouches[0].screenX;
      touchStartY = e.changedTouches[0].screenY;
      isSwiping = true;
    }, { passive: true });
    
    carouselContainer.addEventListener('touchmove', (e) => {
      if (!isSwiping) return;
      
      const currentX = e.changedTouches[0].screenX;
      const currentY = e.changedTouches[0].screenY;
      const diffX = Math.abs(currentX - touchStartX);
      const diffY = Math.abs(currentY - touchStartY);
      
      // If horizontal swipe is more pronounced than vertical, prevent scrolling
      if (diffX > diffY && diffX > 10) {
        e.preventDefault();
      }
    }, { passive: false });
    
    carouselContainer.addEventListener('touchend', (e) => {
      if (!isSwiping) return;
      
      touchEndX = e.changedTouches[0].screenX;
      touchEndY = e.changedTouches[0].screenY;
      handleSwipe();
      isSwiping = false;
    }, { passive: true });
  }
});

function handleSwipe() {
  const swipeThreshold = 50;
  const diffX = touchStartX - touchEndX;
  const diffY = Math.abs(touchStartY - touchEndY);
  
  // Only trigger swipe if horizontal movement is more significant than vertical
  if (Math.abs(diffX) > swipeThreshold && Math.abs(diffX) > diffY) {
    if (diffX > 0) {
      moveCarousel(1); // Swipe left - next slide
    } else {
      moveCarousel(-1); // Swipe right - previous slide
    }
  }
}

// Handle keyboard navigation
document.addEventListener('keydown', (e) => {
  const carouselContainer = document.querySelector('.events-carousel-container');
  if (!carouselContainer || !carouselContainer.contains(document.activeElement)) {
    return;
  }
  
  switch (e.key) {
    case 'ArrowLeft':
      e.preventDefault();
      moveCarousel(-1);
      break;
    case 'ArrowRight':
      e.preventDefault();
      moveCarousel(1);
      break;
    case 'Home':
      e.preventDefault();
      goToSlide(0);
      break;
    case 'End':
      e.preventDefault();
      goToSlide(totalSlides - 1);
      break;
  }
});
</script>
{% endif %}
